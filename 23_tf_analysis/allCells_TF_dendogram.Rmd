---
title: "R Notebook"
output: html_notebook
---

```{r}
library(Seurat)
library(cowplot)
library(data.table)
library(dplyr)
library(tidyr)
library(parallel)
library(cba)
library(here)
library(RColorBrewer)
library(tidyverse)
library(openxlsx)
library(gplots)
library(reshape2)

library(ggplot2)
library(ggdendro)
library(scales)
library(wordspace)
library(GMD)

library(dendextend)
library(circlize)


library(ontologyIndex)
library(ontologyPlot)
library(ontologySimilarity)
# library(devtools)
# install_github("cvarrichio/Matrix.utils")
# library(Matrix.utils)
```

# Load Seurat object of data
```{r}
#tiss <- load(here('00_data_ingest', '11_global_robj','FACS_all.Robj'))
tm.droplet.matrix = readRDS(here("data-tabula-muris", "TM_droplet_mat.rds"))
tm.droplet.metadata = read_csv(here("data-tabula-muris", "TM_droplet_metadata.csv"))
#tissDROPLET <- CreateSeuratObject(raw.data = tm.droplet.matrix, meta.data = tm.droplet.metadata)

tm.facs.matrix = readRDS(here("data-tabula-muris", "TM_facs_mat.rds"))
tm.facs.metadata = read_csv(here("data-tabula-muris", "TM_facs_metadata.csv"))
#tissFACS <- CreateSeuratObject(raw.data = tm.facs.matrix, meta.data = tm.facs.metadata)
```

# Load ontology 
```{r}

co = get_ontology('https://raw.githubusercontent.com/obophenotype/cell-ontology/master/cl-basic.obo', extract_tags='everything')

```
Since an ontology is just a collection of `is_a` relationships, the most straightforward distance between nodes will be a function of the two sets of attributes posessed by the nodes.

The number of unshared attributes (the set disjunction) can be easily computed as (union - intersection) of the ancestor sets. In the case of a tree, this is just the tree distance.

```{r}
ont_dist <- function(ontology, id1, id2){
  anc1 = get_ancestors(ontology, id1)
  anc2 = get_ancestors(ontology, id2)
  length(union(anc1, anc2)) - length(intersect(anc1, anc2))
}
```

Since it's not a tree, though, the distance is somewhat larger.

```{r}
plot_common_tree <- function(t1, t2){
  onto_plot(co, terms = intersection_with_descendants(co, "CL:0000548", union(get_ancestors(co, t1), get_ancestors(co, t2))))
}
```

# Load TFs 
```{r}
# (1140 genes from MGI, filtered by GO Term = "DNA binding transcription factor activity", GO ID ?)
tfs      <- read.csv(here('23_tf_analysis','GO_term_summary_20171110_222852.csv'))
tf.names <- as.character( tfs %>% distinct(Symbol) %>% pull(Symbol) )
tf.names <- make.names(tf.names)
#tf.names <- tf.names[tf.names %in% rownames(tissFACS@data)]
length(tf.names)

# # remove genes with very low expression in data
# x=apply(as.matrix(tissFACS@data[tf.names, ]) > 0, 1, sum) 
# genes.expr <- names(x[x > 5])
# tf.names <- tf.names[tf.names %in% genes.expr]

# Remove IEGs
# iegs <- as.character(read.csv(file.path(tabula.dir,"00_data_ingest/20_dissociation_genes/genes_affected_by_dissociation_unix.csv"), header = T)[,1])

iegs <- as.character(read.csv(here('00_data_ingest','20_dissociation_genes','genes_affected_by_dissociation_unix.csv'), header = T)[,1])

tf.names <- tf.names[!tf.names %in% iegs]
length(tf.names)
```

# Load RNA splicing factors 
```{r}
# (1140 genes from MGI, filtered by GO Term = "DNA binding transcription factor activity", GO ID ?)
rna.sfs      <- read.csv(here('23_tf_analysis','GO_term_summary_20171214_190641.csv'))
rna.sfs.names <- as.character( rna.sfs %>% distinct(Symbol) %>% pull(Symbol) )
rna.sfs.names <- make.names(rna.sfs.names)
#tf.names <- tf.names[tf.names %in% rownames(tissFACS@data)]
length(rna.sfs.names)

# # remove genes with very low expression in data
# x=apply(as.matrix(tissFACS@data[tf.names, ]) > 0, 1, sum) 
# genes.expr <- names(x[x > 5])
# tf.names <- tf.names[tf.names %in% genes.expr]

# Remove IEGs
# iegs <- as.character(read.csv(file.path(tabula.dir,"00_data_ingest/20_dissociation_genes/genes_affected_by_dissociation_unix.csv"), header = T)[,1])

iegs <- as.character(read.csv(here('00_data_ingest','20_dissociation_genes','genes_affected_by_dissociation_unix.csv'), header = T)[,1])

rna.sfs.names <- rna.sfs.names[!rna.sfs.names %in% iegs]
length(rna.sfs.names)
```

# Load inflammatory genes
```{r}
# (1140 genes from MGI, filtered by GO Term = "DNA binding transcription factor activity", GO ID ?)
inflams      <- read.csv(here('23_tf_analysis','GO_term_summary_20171214_212745.csv'))
inflams.names <- as.character( inflams %>% distinct(Symbol) %>% pull(Symbol) )
inflams.names <- make.names(inflams.names)
#tf.names <- tf.names[tf.names %in% rownames(tissFACS@data)]
length(inflams.names)

# # remove genes with very low expression in data
# x=apply(as.matrix(tissFACS@data[tf.names, ]) > 0, 1, sum) 
# genes.expr <- names(x[x > 5])
# tf.names <- tf.names[tf.names %in% genes.expr]

# Remove IEGs
# iegs <- as.character(read.csv(file.path(tabula.dir,"00_data_ingest/20_dissociation_genes/genes_affected_by_dissociation_unix.csv"), header = T)[,1])

iegs <- as.character(read.csv(here('00_data_ingest','20_dissociation_genes','genes_affected_by_dissociation_unix.csv'), header = T)[,1])

inflams.names <- inflams.names[!inflams.names %in% iegs]
length(inflams.names)
```


# Calculate global dendogram - FACS with TFs
```{r}

tm.facs.matrix.tfs <- tm.facs.matrix[rownames(tm.facs.matrix) %in% tf.names,]
tm.facs.matrix.tfs <- as.data.frame(t(as.matrix(tm.facs.matrix.tfs)))

tm.facs.matrix.tfs$factors <- as.factor(tm.facs.metadata$cell_ontology_class)
# tm.facs.matrix.tfs$factors <- as.factor(tm.facs.metadata$cell_ontology_id)
# tm.facs.matrix.tfs$factors <- paste(tm.facs.metadata$cell_ontology_class, tm.facs.metadata$tissue, sep="_")

# consider only TFs that are not affected by dissociation
tm.facs.matrix.tfs.cellids <- tm.facs.matrix.tfs %>% 
  group_by(factors) %>%
  summarise_at(vars(colnames(tm.facs.matrix.tfs[1:1016])),funs(sum(., na.rm=TRUE)))


tm.facs.matrix.tfs.cellids.norm = tm.facs.matrix.tfs.cellids
for (i in 1:82){
  jaux = sum(tm.facs.matrix.tfs.cellids[i,2:1017])
  for (j in 2:1017){
    tm.facs.matrix.tfs.cellids.norm[i,j] = tm.facs.matrix.tfs.cellids[i,j]/jaux
  }
}
# tm.facs.matrix.tfs.cellids.norm <- tm.facs.matrix.tfs.cellids.norm[,2:1017]
# 
# 
# tm.facs.matrix.tfs.cellids.norm = tm.facs.matrix.tfs.cellids
# for (i in 1:130){
#   jaux = sum(tm.facs.matrix.tfs.cellids[i,2:1017])
#   for (j in 2:1017){
#     tm.facs.matrix.tfs.cellids.norm[i,j] = tm.facs.matrix.tfs.cellids[i,j]/jaux
#   }
# }
tm.facs.matrix.tfs.cellids.norm <- as.data.frame(tm.facs.matrix.tfs.cellids.norm)
tm.facs.matrix.tfs.cellids.norm <- subset(tm.facs.matrix.tfs.cellids.norm,!is.na(factors))
rownames(tm.facs.matrix.tfs.cellids.norm) <- tm.facs.matrix.tfs.cellids.norm$factors
tm.facs.matrix.tfs.cellids.norm <- tm.facs.matrix.tfs.cellids.norm[,-1]
dnorm <- dist(tm.facs.matrix.tfs.cellids.norm)
labels(dnorm)
#tm.facs.matrix.tfs.cellids.norm <- tm.facs.matrix.tfs.cellids.norm[,2:1017]

# hmcol = colorRampPalette(brewer.pal(9, "RdBu"))(100)
#heatmap.2(as.matrix(as.data.frame(lapply(tm.facs.matrix.tfs.cellids.norm, as.numeric))),scale="column",trace = "none",col = hmcol, dendrogram = "both", labRow = tm.facs.matrix.tfs.cellids$factors, labCol = FALSE)

# d <- dist(as.matrix(as.data.frame(lapply(tm.facs.matrix.tfs.cellids[,-1], as.numeric))), method = "euclidean", diag = FALSE, upper = FALSE, p = 2)
# h <- hclust(d, method = "complete", members = NULL)
# plot(h, labels = tm.facs.matrix.tfs.cellids$factors, hang = 0.1, check = TRUE,
#      axes = TRUE, frame.plot = FALSE, ann = FALSE,
#      main = "Cluster Dendrogram",
#      sub = NULL, xlab = "", ylab = "", which.plots=2, cex=.5)
# 
# 
# dnorm <- dist(as.matrix(as.data.frame(lapply(tm.facs.matrix.tfs.cellids.norm, as.numeric))), method = "euclidean", diag = FALSE, upper = FALSE, p = 2)
hnorm <- hclust(dnorm, method = "ward.D2", members = NULL)
plot(hnorm,  hang = 0.1, check = TRUE,
     axes = TRUE, frame.plot = FALSE, ann = FALSE,
     main = "Cluster Dendrogram",
     sub = NULL, xlab = "", ylab = "", which.plots=2, cex=.5)

# # create a dendrogram
# hc <- hclust(dnorm)#, method = "complete", members = NULL)
# #hc$labels = tm.facs.matrix.tfs.cellids$factors
# dend <- as.dendrogram(hc)
# head(labels(dend))

```


# Calculate global dendogram - FACS with RNAs
```{r}

tm.facs.matrix.rna.sfs <- tm.facs.matrix[rownames(tm.facs.matrix) %in% rna.sfs.names,]
tm.facs.matrix.rna.sfs <- as.data.frame(t(as.matrix(tm.facs.matrix.rna.sfs)))


tm.facs.matrix.rna.sfs$factors <- as.factor(tm.facs.metadata$cell_ontology_class)
#tm.facs.matrix.tfs$tissues <- as.factor(tm.facs.metadata$tissue)

# consider only TFs that are not affected by dissociation
tm.facs.matrix.rna.sfs.cellids <- tm.facs.matrix.rna.sfs %>% 
  group_by(factors) %>%
  summarise_at(vars(colnames(tm.facs.matrix.rna.sfs[1:320])),funs(sum(., na.rm=TRUE)))


tm.facs.matrix.rna.sfs.cellids.norm = tm.facs.matrix.rna.sfs.cellids
for (i in 1:82){
  jaux = sum(tm.facs.matrix.rna.sfs.cellids[i,2:321])
  for (j in 2:321){
    tm.facs.matrix.rna.sfs.cellids.norm[i,j] = tm.facs.matrix.rna.sfs.cellids[i,j]/jaux
  }
}
# tm.facs.matrix.rna.sfs.cellids.norm <- tm.facs.matrix.rna.sfs.cellids.norm[,-1]
tm.facs.matrix.rna.sfs.cellids.norm <- as.data.frame(tm.facs.matrix.rna.sfs.cellids.norm)
tm.facs.matrix.rna.sfs.cellids.norm <- subset(tm.facs.matrix.rna.sfs.cellids.norm,!is.na(factors))
rownames(tm.facs.matrix.rna.sfs.cellids.norm) <- tm.facs.matrix.rna.sfs.cellids.norm$factors
tm.facs.matrix.rna.sfs.cellids.norm <- tm.facs.matrix.rna.sfs.cellids.norm[,-1]
dnormRNA <- dist(tm.facs.matrix.rna.sfs.cellids.norm)
labels(dnormRNA)

hnormRNA <- hclust(dnormRNA, method = "ward.D2", members = NULL)
dend3 <- hnormRNA %>% as.dendrogram
# hmcol = colorRampPalette(brewer.pal(9, "RdBu"))(100)
#heatmap.2(as.matrix(as.data.frame(lapply(tm.facs.matrix.tfs.cellids.norm, as.numeric))),scale="column",trace = "none",col = hmcol, dendrogram = "both", labRow = tm.facs.matrix.tfs.cellids$factors, labCol = FALSE)

d <- dist(as.matrix(as.data.frame(lapply(tm.facs.matrix.rna.sfs.cellids[,-1], as.numeric))), method = "euclidean", diag = FALSE, upper = FALSE, p = 2)
h <- hclust(d, method = "complete", members = NULL)
plot(h, labels = tm.facs.matrix.rna.sfs.cellids$factors, hang = 0.1, check = TRUE,
     axes = TRUE, frame.plot = FALSE, ann = FALSE,
     main = "Cluster Dendrogram",
     sub = NULL, xlab = "", ylab = "", which.plots=2, cex=.5)


dnorm <- dist(as.matrix(as.data.frame(lapply(tm.facs.matrix.rna.sfs.cellids.norm, as.numeric))), method = "euclidean", diag = FALSE, upper = FALSE, p = 2)
hnorm <- hclust(dnorm, method = "complete", members = NULL)
plot(hnorm, labels = tm.facs.matrix.rna.sfs.cellids$factors, hang = 0.1, check = TRUE,
     axes = TRUE, frame.plot = FALSE, ann = FALSE,
     main = "Cluster Dendrogram",
     sub = NULL, xlab = "", ylab = "", which.plots=2, cex=.5)

# #convert cluster object to use with ggplot
# dendr <- dendro_data(h, type="rectangle") 
# 
# #your own labels (now rownames) are supplied in geom_text() and label=label
# ggplot() + 
#   geom_segment(data=segment(dendr), aes(x=x, y=y, xend=xend, yend=yend)) + 
#   geom_text(data=label(dendr), aes(x=x, y=y, label=tm.facs.matrix.tfs.cellids$factors, hjust=0), size=3) +
#   coord_flip() + scale_y_reverse(expand=c(0.2, 0)) + 
#   theme(axis.line.y=element_blank(),
#         axis.ticks.y=element_blank(),
#         axis.text.y=element_blank(),
#         axis.title.y=element_blank(),
#         panel.background=element_rect(fill="white"),
#         panel.grid=element_blank())
# ggsave("tf_dendro_all.pdf", plot = last_plot(), device = "pdf", path = NULL,
#   scale = 1, width = 20, height = 20, units = "cm",
#   dpi = 150, limitsize = FALSE)

```

# Calculate ont_dist
```{r}
tm.facs.ids <- unique(tm.facs.metadata$cell_ontology_id[!is.na(tm.facs.metadata$cell_ontology_id)])
onto_plot(co, terms=tm.facs.ids)

onto_plot(co, terms=intersection_with_descendants(co,tm.facs.ids,get_ancestors(co, tm.facs.ids)))

sim_mat <- get_sim_grid(ontology=co, term_sets=list(tm.facs.ids))
sim_mat

nids = length(tm.facs.ids)
D = matrix(nrow = nids, ncol = nids)
for (i in 1:nids){
  for(j in 1:nids){
    D[i,j] = ont_dist(co, tm.facs.ids[i], tm.facs.ids[j])
  }
}
rownames(D) = co$name[tm.facs.ids]
colnames(D) = co$name[tm.facs.ids]
d = as.dist(D)

honto <- hclust(d, method = "ward.D2")
plot(honto, hang = 0.1, check = TRUE,
     axes = TRUE, frame.plot = FALSE, ann = FALSE,
     main = "Cluster Dendrogram",
     sub = NULL, xlab = "", ylab = "", which.plots=2, cex=.5)

for (i in 1:length(honto$labels)){
  honto$labels[i] <-  honto$labels[[i]]
}

```

# Compute and compare dendrogram
# Tanglegram
```{r fig.height = 15, fig.width = 25}

dend1 <- honto %>% as.dendrogram
labels(dend1) <- labels(honto)
dend2 <- hnorm %>% as.dendrogram
dend12 <- dendlist(dend1, dend2)
dend13 <- dendlist(dend1, dend3)
dend_diff(dend1, dend2)
# dend12 %>% untangle %>% tanglegram
dend12 %>% tanglegram(common_subtrees_color_branches = TRUE)
dend12 %>% tanglegram(lab.cex = 1, lwd = .5,edge.lwd = NULL,common_subtrees_color_branches = TRUE,common_subtrees_color_lines = TRUE,
                      columns_width = c(15, 5, 15),main_left = "Ontology",main_right = "TFs", dLeaf = 1,type = "r")#,  
 margin_inner= 3.5, center = TRUE,
  dLeaf = -0.1, xlim = c(5.1,0), columns_width= c(5,1,5),
   )
tanglegram(dend1 , dend2, sort = TRUE)

set.seed(3958)
x <- dend12 %>% untangle(method = "random", R = 10) 
x %>% plot(main = paste("entanglement =", round(entanglement(x), 2)))

x <- dend12 %>% untangle(method = "step2side") 
x %>% plot(main = paste("entanglement =", round(entanglement(x), 2)))

# compare the 2 trees
dend.comp <- all.equal(dend1, dend2, use.edge.length = FALSE, use.tip.label.order = FALSE, use.tip.label = TRUE, use.topology = FALSE, tolerance = .Machine$double.eps^0.5, scale = NULL)

```
Calculate BK distance

```{r}
FM_index(cutree(honto, k=3), cutree(hnorm, k=3)) 
cor_cophenetic(dend1, dend2)
cor_bakers_gamma(dend1, dend2)
cor_bakers_gamma(dend1, dend3)
Bk_plot(dend1, dend1, main = "CORRECT Bk plot \n(based on dendrograms)")
Bk_plot(dend1, dend2, main = "CORRECT Bk plot \n(based on dendrograms)")
Bk_plot(dend1, dend3, main = "CORRECT Bk plot \n(based on dendrograms)")


```



# Calculate global dendogram - single cells FACS
```{r}

# we can think of comparing the dendrogram we obtain with the known labels to the dendrogram we can generate using single cells
tm.facs.matrix.tfs <- tm.facs.matrix[rownames(tm.facs.matrix) %in% tf.names,]
tm.facs.matrix.tfs <- as.data.frame(t(as.matrix(tm.facs.matrix.tfs)))
tm.facs.matrix.tfs.sc <- tm.facs.matrix.tfs
tm.facs.matrix.tfs.sc$factors <- tm.facs.metadata$cell_ontology_class[match(rownames(tm.facs.matrix.tfs.sc),tm.facs.metadata$cell)]
tm.facs.matrix.tfs.sc$cells <- tm.facs.metadata$cell[match(rownames(tm.facs.matrix.tfs.sc),tm.facs.metadata$cell)]

tm.facs.matrix.tfs.sc <- tm.facs.matrix.tfs.sc %>%
  group_by(factors) %>%
  sample_n(size = 22)

tm.facs.matrix.tfs.sc <- as.data.frame(tm.facs.matrix.tfs.sc)
row.names(tm.facs.matrix.tfs.sc) <- tm.facs.matrix.tfs.sc$cells
tm.facs.matrix.tfs.sc <- as.matrix(tm.facs.matrix.tfs.sc[,1:1016])
d.sc <- dist(tm.facs.matrix.tfs.sc, method = "euclidean", diag = FALSE, upper = FALSE, p = 2)
hc.sc <- hclust(d.sc, method = "complete", members = NULL)
dend.sc <- as.dendrogram(hc.sc)
head(labels(dend.sc))
labels(dend.sc) <- tm.facs.metadata$cell_ontology_class[match(labels(dend.sc),tm.facs.metadata$cell)]
head(labels(dend.sc))
labels.dend.sc <- labels(dend.sc)
plot(dend.sc)

# now the challenging is how to prune this dendrogram in a meaningful way to allow comparisons because the sc one is much bigger and the comparison function doesn't work.. 

dend.comp <- all.equal(dend, dend.sc, use.edge.length = FALSE, use.tip.label.order = FALSE, use.tip.label = TRUE, use.topology = FALSE, tolerance = .Machine$double.eps^0.5, scale = NULL)

collapse.dend.sc <- cutree(dend.sc, k = 82, h = NULL, use_labels_not_values = TRUE, order_clusters_as_data = TRUE, warn = dendextend_options("warn"), NA_to_0L = TRUE)
plot(collapse.dend.sc)



tm.facs.matrix.tfs.sc$factors <- tm.facs.metadata$cell_ontology_class[match(rownames(tm.facs.matrix.tfs.sc),tm.facs.metadata$cell)]
  
d <- dist(as.matrix(as.data.frame(lapply(tm.facs.matrix.tfs.sc[,1:1012], as.numeric))), method = "euclidean", diag = FALSE, upper = FALSE, p = 2)

h <- hclust(d, method = "complete", members = NULL)
plot(h, labels = tm.facs.matrix.tfs.sc$factors, hang = 0.1, check = TRUE,
     axes = TRUE, frame.plot = FALSE, ann = FALSE,
     main = "Cluster Dendrogram",
     sub = NULL, xlab = "", ylab = "", which.plots=2, cex=.5)


# tm.facs.matrix.tfs.sc <- tm.facs.matrix.tfs[rowSums(tm.facs.matrix.tfs > 10) >= 100, ]
# tm.facs.matrix.tfs.sc <- tm.facs.matrix.tfs[,colSums(tm.facs.matrix.tfs > 10) >= 1000]

# create a dendrogram

# modify the dendrogram to have some colors in the branches and labels
dend <- dend %>% 
   color_branches(k=4) %>% 
   color_labels

# plot the radial plot
par(mar = rep(0,4))
# circlize_dendrogram(dend, dend_track_height = 0.8) 
circlize_dendrogram(dend, labels_track_height = NA, dend_track_height = .3) 

# color a dendrogram’s labels according to defined groups
par(mfrow = c(1,2), mar = c(5,2,1,0))
 dend <- dend %>%
          color_branches(k = 3) %>%
          set("branches_lwd", c(2,1,2)) %>%
          set("branches_lty", c(1,2,1))
 
 plot(dend)

 dend <- color_labels(dend, k = 3)
 # The same as:
 # labels_colors(dend)  <- get_leaves_branches_col(dend)
 plot(dend)

```




```{r}
# consider only TFs that are not affected by dissociation
tm.facs.matrix.tfs.cellids <- tm.facs.matrix.tfs %>% 
  group_by(factors) %>%
  summarise_at(vars(colnames(tm.facs.matrix.tfs[1:1016])),funs(sum(., na.rm=TRUE)))


tm.facs.matrix.tfs.cellids.norm = tm.facs.matrix.tfs.cellids
for (i in 1:82){
  jaux = sum(tm.facs.matrix.tfs.cellids[i,2:1017])
  for (j in 2:1017){
    tm.facs.matrix.tfs.cellids.norm[i,j] = tm.facs.matrix.tfs.cellids[i,j]/jaux
  }
}
tm.facs.matrix.tfs.cellids.norm <- tm.facs.matrix.tfs.cellids.norm[,-1]

hmcol = colorRampPalette(brewer.pal(9, "RdBu"))(100)
heatmap.2(as.matrix(as.data.frame(lapply(tm.facs.matrix.tfs.cellids.norm, as.numeric))),scale="column",trace = "none",col = hmcol, dendrogram = "both", labRow = tm.facs.matrix.tfs.cellids$factors, labCol = FALSE)

d <- dist(as.matrix(as.data.frame(lapply(tm.facs.matrix.tfs.cellids[,-1], as.numeric))), method = "euclidean", diag = FALSE, upper = FALSE, p = 2)
h <- hclust(d, method = "complete", members = NULL)
plot(h, labels = tm.facs.matrix.tfs.cellids$factors, hang = 0.1, check = TRUE,
     axes = TRUE, frame.plot = FALSE, ann = FALSE,
     main = "Cluster Dendrogram",
     sub = NULL, xlab = "", ylab = "", which.plots=2, cex=.5)


dnorm <- dist(as.matrix(as.data.frame(lapply(tm.facs.matrix.tfs.cellids.norm, as.numeric))), method = "euclidean", diag = FALSE, upper = FALSE, p = 2)
hnorm <- hclust(dnorm, method = "complete", members = NULL)
plot(hnorm, labels = tm.facs.matrix.tfs.cellids$factors, hang = 0.1, check = TRUE,
     axes = TRUE, frame.plot = FALSE, ann = FALSE,
     main = "Cluster Dendrogram",
     sub = NULL, xlab = "", ylab = "", which.plots=2, cex=.5)

#convert cluster object to use with ggplot
dendr <- dendro_data(h, type="rectangle") 

#your own labels (now rownames) are supplied in geom_text() and label=label
ggplot() + 
  geom_segment(data=segment(dendr), aes(x=x, y=y, xend=xend, yend=yend)) + 
  geom_text(data=label(dendr), aes(x=x, y=y, label=tm.facs.matrix.tfs.cellids$factors, hjust=0), size=3) +
  coord_flip() + scale_y_reverse(expand=c(0.2, 0)) + 
  theme(axis.line.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_rect(fill="white"),
        panel.grid=element_blank())
ggsave("tf_dendro_all.pdf", plot = last_plot(), device = "pdf", path = NULL,
  scale = 1, width = 20, height = 20, units = "cm",
  dpi = 150, limitsize = FALSE)

```

# Calculate global dendogram - 10x with TFs
```{r}

tm.droplet.matrix.tfs <- tm.droplet.matrix[rownames(tm.droplet.matrix) %in% tf.names,]
tm.droplet.matrix.tfs <- as.data.frame(t(as.matrix(tm.droplet.matrix.tfs)))

# htfs <- hist(statsTFs,
#              breaks=c(seq(0, 200, length.out = 50),400,600), col = "red")
# hall <- hist(statsAll,
#              breaks=c(seq(0, 200, length.out = 50),20000,130000), col = "red")



tm.droplet.matrix.tfs$factors <- as.factor(tm.droplet.metadata$cell_ontology_class)
#tm.facs.matrix.tfs$tissues <- as.factor(tm.facs.metadata$tissue)

# consider only TFs that are not affected by dissociation
tm.droplet.matrix.tfs.cellids <- tm.droplet.matrix.tfs %>% 
  group_by(factors) %>%
  summarise_at(vars(colnames(tm.droplet.matrix.tfs[1:1016])),funs(sum(., na.rm=TRUE)))


tm.droplet.matrix.tfs.cellids.norm = tm.droplet.matrix.tfs.cellids
for (i in 1:58){
  jaux = sum(tm.droplet.matrix.tfs.cellids[i,2:1017])
  for (j in 2:1017){
    tm.droplet.matrix.tfs.cellids.norm[i,j] = tm.droplet.matrix.tfs.cellids[i,j]/jaux
  }
}
tm.droplet.matrix.tfs.cellids.norm <- tm.droplet.matrix.tfs.cellids.norm[,-1]

hmcol = colorRampPalette(brewer.pal(9, "RdBu"))(100)
heatmap.2(as.matrix(as.data.frame(lapply(tm.facs.matrix.tfs.cellids.norm, as.numeric))),scale="column",trace = "none",col = hmcol, dendrogram = "both", labRow = tm.facs.matrix.tfs.cellids$factors, labCol = FALSE)

d <- dist(as.matrix(as.data.frame(lapply(tm.facs.matrix.tfs.cellids[,-1], as.numeric))), method = "euclidean", diag = FALSE, upper = FALSE, p = 2)
h <- hclust(d, method = "complete", members = NULL)
plot(h, labels = tm.facs.matrix.tfs.cellids$factors, hang = 0.1, check = TRUE,
     axes = TRUE, frame.plot = FALSE, ann = FALSE,
     main = "Cluster Dendrogram",
     sub = NULL, xlab = "", ylab = "", which.plots=2, cex=.5)
# dist.topo in ape library


dnorm <- dist(as.matrix(as.data.frame(lapply(tm.droplet.matrix.tfs.cellids.norm, as.numeric))), method = "euclidean", diag = FALSE, upper = FALSE, p = 2)
hnorm <- hclust(dnorm, method = "complete", members = NULL)
plot(hnorm, labels = tm.droplet.matrix.tfs.cellids$factors, hang = 0.1, check = TRUE,
     axes = TRUE, frame.plot = FALSE, ann = FALSE,
     main = "Cluster Dendrogram",
     sub = NULL, xlab = "", ylab = "", which.plots=2, cex=.5)

# #convert cluster object to use with ggplot
# dendr <- dendro_data(h, type="rectangle") 
# 
# #your own labels (now rownames) are supplied in geom_text() and label=label
# ggplot() + 
#   geom_segment(data=segment(dendr), aes(x=x, y=y, xend=xend, yend=yend)) + 
#   geom_text(data=label(dendr), aes(x=x, y=y, label=tm.facs.matrix.tfs.cellids$factors, hjust=0), size=3) +
#   coord_flip() + scale_y_reverse(expand=c(0.2, 0)) + 
#   theme(axis.line.y=element_blank(),
#         axis.ticks.y=element_blank(),
#         axis.text.y=element_blank(),
#         axis.title.y=element_blank(),
#         panel.background=element_rect(fill="white"),
#         panel.grid=element_blank())
# ggsave("tf_dendro_all.pdf", plot = last_plot(), device = "pdf", path = NULL,
#   scale = 1, width = 20, height = 20, units = "cm",
#   dpi = 150, limitsize = FALSE)

```


# Calculate global dendogram - 10x with RNAs
```{r}

tm.droplet.matrix.rna.sfs <- tm.droplet.matrix[rownames(tm.droplet.matrix) %in% rna.sfs.names,]
tm.droplet.matrix.rna.sfs <- as.data.frame(t(as.matrix(tm.droplet.matrix.rna.sfs)))

# htfs <- hist(statsTFs,
#              breaks=c(seq(0, 200, length.out = 50),400,600), col = "red")
# hall <- hist(statsAll,
#              breaks=c(seq(0, 200, length.out = 50),20000,130000), col = "red")



tm.droplet.matrix.rna.sfs$factors <- as.factor(tm.droplet.metadata$cell_ontology_class)
#tm.facs.matrix.tfs$tissues <- as.factor(tm.facs.metadata$tissue)

# consider only TFs that are not affected by dissociation
tm.droplet.matrix.rna.sfs.cellids <- tm.droplet.matrix.rna.sfs %>% 
  group_by(factors) %>%
  summarise_at(vars(colnames(tm.droplet.matrix.rna.sfs[1:320])),funs(sum(., na.rm=TRUE)))


tm.droplet.matrix.rna.sfs.cellids.norm = tm.droplet.matrix.rna.sfs.cellids
for (i in 1:58){
  jaux = sum(tm.droplet.matrix.rna.sfs.cellids[i,2:321])
  for (j in 2:321){
    tm.droplet.matrix.rna.sfs.cellids.norm[i,j] = tm.droplet.matrix.rna.sfs.cellids[i,j]/jaux
  }
}
tm.droplet.matrix.rna.sfs.cellids.norm <- tm.droplet.matrix.rna.sfs.cellids.norm[,-1]

hmcol = colorRampPalette(brewer.pal(9, "RdBu"))(100)
#heatmap.2(as.matrix(as.data.frame(lapply(tm.droplet.matrix.rna.sfs.cellids.norm, as.numeric))),scale="column",trace = "none",col = hmcol, dendrogram = "both", labRow = tm.facs.matrix.tfs.cellids$factors, labCol = FALSE)

d <- dist(as.matrix(as.data.frame(lapply(tm.droplet.matrix.rna.sfs.cellids.norm[,-1], as.numeric))), method = "euclidean", diag = FALSE, upper = FALSE, p = 2)
h <- hclust(d, method = "complete", members = NULL)
plot(h, labels = tm.droplet.matrix.rna.sfs.cellids$factors, hang = 0.1, check = TRUE,
     axes = TRUE, frame.plot = FALSE, ann = FALSE,
     main = "Cluster Dendrogram",
     sub = NULL, xlab = "", ylab = "", which.plots=2, cex=.5)
# dist.topo in ape library


dnorm <- dist(as.matrix(as.data.frame(lapply(tm.droplet.matrix.rna.sfs.cellids.norm, as.numeric))), method = "euclidean", diag = FALSE, upper = FALSE, p = 2)
hnorm <- hclust(dnorm, method = "complete", members = NULL)
plot(hnorm, labels = tm.droplet.matrix.rna.sfs.cellids$factors, hang = 0.1, check = TRUE,
     axes = TRUE, frame.plot = FALSE, ann = FALSE,
     main = "Cluster Dendrogram",
     sub = NULL, xlab = "", ylab = "", which.plots=2, cex=.5)

# #convert cluster object to use with ggplot
# dendr <- dendro_data(h, type="rectangle") 
# 
# #your own labels (now rownames) are supplied in geom_text() and label=label
# ggplot() + 
#   geom_segment(data=segment(dendr), aes(x=x, y=y, xend=xend, yend=yend)) + 
#   geom_text(data=label(dendr), aes(x=x, y=y, label=tm.facs.matrix.tfs.cellids$factors, hjust=0), size=3) +
#   coord_flip() + scale_y_reverse(expand=c(0.2, 0)) + 
#   theme(axis.line.y=element_blank(),
#         axis.ticks.y=element_blank(),
#         axis.text.y=element_blank(),
#         axis.title.y=element_blank(),
#         panel.background=element_rect(fill="white"),
#         panel.grid=element_blank())
# ggsave("tf_dendro_all.pdf", plot = last_plot(), device = "pdf", path = NULL,
#   scale = 1, width = 20, height = 20, units = "cm",
#   dpi = 150, limitsize = FALSE)

```

```{r}

# plot the global expression of TFs as histogram (let's try!)
hist(as.matrix(as.data.frame(lapply(tm.facs.matrix.tfs.cellids, as.numeric))))
hist(as.matrix(as.data.frame(lapply(tm.facs.matrix.tfs.cellids, as.numeric))))


```


```{r}
# cnsider all TFs
tm.facs.matrix.tfs.cellids <- tm.facs.matrix.tfs %>% 
  group_by(factors) %>%
  summarise_at(vars(colnames(tm.facs.matrix.tfs[1:1048])),funs(sum(., na.rm=TRUE)))

tm.facs.matrix.tfs.cellids.norm = tm.facs.matrix.tfs.cellids
for (i in 1:82){
  jaux = sum(tm.facs.matrix.tfs.cellids[i,2:1049])
  for (j in 2:1049){
    tm.facs.matrix.tfs.cellids.norm[i,j] = tm.facs.matrix.tfs.cellids[i,j]/jaux
  }
}
tm.facs.matrix.tfs.cellids.norm <- tm.facs.matrix.tfs.cellids.norm[,-1]

heatmap.2(as.matrix(as.data.frame(lapply(tm.facs.matrix.tfs.cellids.norm, as.numeric))),scale="row",trace = "n",)

d <- dist(as.matrix(as.data.frame(lapply(tm.facs.matrix.tfs.cellids[,-1], as.numeric))), method = "euclidean", diag = FALSE, upper = FALSE, p = 2)
h <- hclust(d, method = "complete", members = NULL)
plot(h, labels = tm.facs.matrix.tfs.cellids$factors, hang = 0.1, check = TRUE,
     axes = TRUE, frame.plot = FALSE, ann = FALSE,
     main = "Cluster Dendrogram",
     sub = NULL, xlab = "", ylab = "", which.plots=2, cex=.5)


dnorm <- dist(as.matrix(as.data.frame(lapply(tm.facs.matrix.tfs.cellids.norm, as.numeric))), method = "euclidean", diag = FALSE, upper = FALSE, p = 2)
hnorm <- hclust(dnorm, method = "complete", members = NULL)
plot(hnorm, labels = tm.facs.matrix.tfs.cellids$factors, hang = 0.1, check = TRUE,
     axes = TRUE, frame.plot = FALSE, ann = FALSE,
     main = "Cluster Dendrogram",
     sub = NULL, xlab = "", ylab = "", which.plots=2, cex=.5)


#convert cluster object to use with ggplot
dendr <- dendro_data(h, type="rectangle") 

#your own labels (now rownames) are supplied in geom_text() and label=label
ggplot() + 
  geom_segment(data=segment(dendr), aes(x=x, y=y, xend=xend, yend=yend)) + 
  geom_text(data=label(dendr), aes(x=x, y=y, label=tm.facs.matrix.tfs.cellids$factors, hjust=0), size=3) +
  coord_flip() + scale_y_reverse(expand=c(0.2, 0)) + 
  theme(axis.line.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_rect(fill="white"),
        panel.grid=element_blank())
ggsave("tf_dendro_all.pdf", plot = last_plot(), device = "pdf", path = NULL,
  scale = 1, width = 20, height = 20, units = "cm",
  dpi = 150, limitsize = FALSE)
```

```{r}
#tm.facs.matrix.tfs <- as.matrix(tm.facs.matrix.tfs)
dim(tm.facs.matrix.tfs)
tm.facs.matrix.tfs$cellID <- tm.facs.metadata$cell_ontology_class

tm.facs.tfs.metadata <- dcast(tm.facs.metadata, cell ~ cell_ontology_class)




tm.facs.tfs.ann <- as.data.frame(tm.facs.metadata, row.names = tm.facs.metadata$cell)
rownames(tm.facs.tfs.ann) <- tm.facs.tfs.ann[,1]


tissFACStfs <- CreateSeuratObject(raw.data = tm.facs.matrix.tfs, meta.data = tm.facs.tfs.ann, min.cells = 50)
tissFACStfs <- SetAllIdent(object = tissFACStfs, id = "cell_ontology_class")
prop.table(x = table(tissFACStfs@ident))
cluster.averages <- AverageExpression(object = tissFACStfs, return.seurat = TRUE)



DoHeatmap(object = cluster.averages, genes.use = PCTopGenes(object = tissFACStfs, pc.use = 1, 
    do.balanced = TRUE), group.label.rot = TRUE, group.cex = 0)

DF <- as.matrix(as.data.frame(lapply(cluster.averages, as.numeric)))
heatmap.2(DF)

heatmap.2(cluster.averages)
tail(x = cluster.averages[, 1:5])
TSNEPlot(tissFACStfs, do.label = TRUE, pt.size = 0.5)

tissFACStfs <- ScaleData(tissFACStfs, display.progress = FALSE)
hv.genes <- rownames(tm.facs.matrix.tfs)
tissFACStfs <- RunPCA(tissFACStfs, pcs.print = 0, pc.genes = rownames(tm.facs.matrix.tfs), pcs.compute = 50)
PCElbowPlot(tissFACStfs, num.pc = 50)
tissFACStfs <- FindClusters(tissFACStfs, dims.use = 1:30, print.output = FALSE)
tissFACStfs <- RunTSNE(tissFACStfs, dims.use = 1:30)



tissFACStfs <- NormalizeData(object = tissFACStfs, normalization.method = "LogNormalize", scale.factor = 10000)
hv.genes <- rownames(tm.facs.matrix.tfs)
tissFACStfs <- ScaleData(object = tissFACStfs , genes.use = hv.genes, display.progress = FALSE, 
    vars.to.regress = NULL, do.par = TRUE, num.cores = 1)

tissFACStfs <- RunPCA(object = tissFACStfs, pc.genes = hv.genes, pcs.compute = 100, do.print = TRUE, 
    pcs.print = 1:5, genes.print = 5)


tissFACStfsmeans <- aggregate.Matrix(tissFACStfs@data, groupings = as.factor(tissFACStfs@meta.data$cell_ontology_class), fun = "mean")

tissFACStfs=BuildClusterTree(tissFACStfs,do.reorder = TRUE,reorder.numeric = TRUE)
heatmap.2(as.matrix(as.data.frame(lapply(tissFACStfs@data, as.numeric))))

DF  <-  as.matrix(as.data.frame(lapply(aux, as.numeric)))
DF <- -log(DF,10)
DF[is.na(DF)] <- 0

dd <- dist(DF, method = "euclidean")
hc <- hclust(dd, method = "ward.D2")

heatmap.2(DF)
```




Other code for plotting dendrograms
```{r}
# modify the dendrogram to have some colors in the branches and labels
dend <- dend %>% 
   color_branches(k=18) %>% 
   color_labels
plot(dend, main = "A color for every state")

plot(as.phylo(hc), type = "fan", cex = .2)


# plot the radial plot
par(mar = rep(0,4))
plot(dend, labels = tm.facs.matrix.tfs.cellids$factors, hang = 0.1, check = TRUE,
     axes = TRUE, frame.plot = FALSE, ann = FALSE,
     main = "Cluster Dendrogram",
     sub = NULL, xlab = "", ylab = "", which.plots=2, cex=.5)
# circlize_dendrogram(dend, dend_track_height = 0.8) 
circlize_dendrogram(dend, labels_track_height = NA, dend_track_height = .3) 

#convert cluster object to use with ggplot
dendr <- dendro_data(hnorm, type="rectangle")
ggdendrogram(hnorm)
#your own labels (now rownames) are supplied in geom_text() and label=label
ggplot() +
  geom_segment(data=segment(dendr), aes(x=x, y=y, xend=xend, yend=yend)) +
  geom_text(data=label(dendr), aes(x=x, y=y, label=tm.facs.matrix.tfs.cellids$factors, hjust=0), size=3) +
  coord_flip() + 
  scale_y_reverse(expand=c(0.2, 0)) +
  theme(axis.line.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_rect(fill="white"),
        panel.grid=element_blank())
# ggsave("tf_dendro_all.pdf", plot = last_plot(), device = "pdf", path = NULL,
#   scale = 1, width = 20, height = 20, units = "cm",
#   dpi = 150, limitsize = FALSE)

```
