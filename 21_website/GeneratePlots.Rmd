---
title: "Notebook for generating plots from saved Seurat Robj."
output: html_notebook
---

```{r}
library(Seurat)
library(tidyverse)
library(here)
library(parallel)
library(foreach)
```

```{r}
source(here("00_data_ingest", "02_tissue_analysis_rmd", "boilerplate.R"))
```


```{r}
genes = c("Chga", "Ins1", "Gcg", "Actb", "Pecam1", "Ptprc", "Cd4", 'Myf5', 'Myod1', 'Pdgfra')
metas = c("cell_ontology_class", "free_annotation", "mouse.sex")
```

Functions for making figures for genes and for metadata.

```{r}
plotgene_tsne <- function(tiss, gene, tissue, method){
  gene_R_safe = paste0("`",gene,"`")
  FetchData(tiss, c('tSNE_1', 'tSNE_2', gene)) %>% ggplot(aes_string(x = 'tSNE_1', y = 'tSNE_2', color = gene_R_safe)) + geom_point(size = 0.5) + 
    scale_colour_gradient(low = "grey", high = "red") + coord_fixed()
  ggsave(here('21_website','images', paste0(tissue, "-", method, "-", gene, "-tsne",".png")))
}

plotgene_vln <- function(tiss, gene, tissue, method){
  VlnPlot(tiss, gene, group.by = 'cell_ontology_class') + coord_flip()
  ggsave(here('21_website','images', paste0(tissue, "-", method, "-", gene,"-vln", ".png")))
}

plotmeta <- function(tiss, meta, tissue, method){
  meta_R_safe = paste0("`",meta,"`")
  FetchData(tiss, c('tSNE_1', 'tSNE_2', meta)) %>% ggplot(aes_string(x = 'tSNE_1', y = 'tSNE_2', color = meta_R_safe)) + geom_point(size = 0.5) + coord_fixed()
  ggsave(here('21_website',"images", paste0(tissue, "-", method, "-", meta, ".png")))
}
```

```{r}
tissue_plots <- function(tissue, method){
  load(here("00_data_ingest","04_tissue_robj_generated", paste0(method, "_", tissue, "_", "seurat_tiss.Robj")))
  for(gene in genes){
    plotgene_tsne(tiss, gene, tissue, method)
    plotgene_vln(tiss, gene, tissue, method)
  }
  for(meta in metas){
    plotmeta(tiss, meta, tissue, method)
  }
}
```

```{r}
tissue_plots("Pancreas", "facs")
tissue_plots("Muscle", "droplet")
tissue_plots("Mammary", "facs")
```


Timing information.

```{r}
ptm <- proc.time()

for(gene in rownames(tiss@data)[10000:10100]){
  plotgene(tiss, gene)
}

proc.time() - ptm
```

